# IMF Monthly Data

```{r}
library(tidyverse)
library(rsdmx)
```

```{r}
imf_CONV <- readxl::read_excel("../../data/raw/imf_CONV.xlsx") 
```



## Exchange Rates

- WESP Code: *_rfx_ncdol / ENDA_XDC_USD_RATE
- WESP Desc: Exchange rates, domestic currency per usd, period average, rate
- IMF Database: [Exchange Rates](https://data.imf.org/en/datasets/IMF.STA:ER)
- IMF Code: XDC_USD; PA_RT

```{r}
flowref <- 'ER'

COUNTRIES <- "*" # All countries
INDICATOR <- "XDC_USD" # selected Indicator
TRANSFORMATION <- "PA_RT" # Period Average, Rate
FREQUENCY <- "M" # Monthly

key <- paste0(COUNTRIES, ".", INDICATOR, ".", TRANSFORMATION, ".", FREQUENCY)
key
```

```{r}
dataset_ER <- as.data.frame(readSDMX(
  providerId = 'IMF_DATA',
  resource = 'data',
  flowRef = flowref,
  key = key,
))
```

```{r}
df_ER <- dataset_ER %>%
  filter(TIME_PERIOD >= 1960) %>%
  arrange(TIME_PERIOD) %>%
  right_join(imf_CONV, by = c("COUNTRY" = "ISO")) %>%
  reframe(
    `Country Name` = Name,
    `Country Code` = Code,
    `Indicator Name` = "Exchange rates, domestic currency per usd, period average, rate",
    `Indicator Code` = "ENDA_XDC_USD_RATE",
    `Attribute` = "Value",
    TIME_PERIOD = gsub("-", "", TIME_PERIOD),
    TIME_PERIOD = gsub("M0", "M", TIME_PERIOD),
    OBS_VALUE
  ) %>%
  pivot_wider(
    names_from = TIME_PERIOD,
    values_from = OBS_VALUE
  ) %>%
  select(-`NA`)
```

Take a look at the data or play around with it
```{r}
# head(df_ER)
```

## Interest Rates

- WESP Code: *_rird / FPOLM_PA
- WESP Desc: Financial, Interest Rates, Monetary Policy-Related Interest Rate, Percent per annum
- IMF Database: [Monetary and Financial Statistics: Interest Rates](https://data.imf.org/en/datasets/IMF.STA:MFS_IR)
- IMF Code: MFS_166_RT_PT_A_PT

```{r}
flowref <- 'MFS_IR'

COUNTRIES <- "*" # All countries
INDICATOR <- "MFS166_RT_PT_A_PT" # selected Indicator
FREQUENCY <- "M" # Monthly

key <- paste0(COUNTRIES, ".", INDICATOR, ".", FREQUENCY)
```

```{r}
dataset_IR <- as.data.frame(readSDMX(
  providerId = 'IMF_DATA',
  resource = 'data',
  flowRef = flowref,
  key = key,
))
```

```{r}
df_IR <- dataset_IR %>%
  filter(
    TIME_PERIOD >= 1960,
    is.na(TIME_PERIOD) == FALSE
    ) %>%
  arrange(TIME_PERIOD) %>%
  right_join(imf_CONV, by = c("COUNTRY" = "ISO")) %>%
  reframe(
    `Country Name` = Name,
    `Country Code` = Code,
    `Indicator Name` = "Financial, Interest Rates, Monetary Policy-Related Interest Rate, Percent per annum",
    `Indicator Code` = "FPOLM_PA", 
    `Attribute` = "Value",
    TIME_PERIOD = gsub("-", "", TIME_PERIOD),
    OBS_VALUE
  ) %>%
  pivot_wider(
    names_from = TIME_PERIOD,
    values_from = OBS_VALUE
  ) %>%
  select(-`NA`)
```

Take a look at the data or play around with it
```{r}
df_IR
```

## Combining + Saving

```{r}
df_imf_monthly <- bind_rows(df_ER, df_IR)
```

```{r}
source("../../src/utils/imf_split.R")

split_dfs <- split_imf_data(df_imf_monthly)
```

```{r}
source("../../src/utils/save_timestamp.R")

# separately save each group with timestamp

timestamp_save(
  df = split_dfs$adv,
  filename = "adv_monthly.xlsx",
  source = "IMF",
  frequency = "monthly"
)

timestamp_save(
  df = split_dfs$developing,
  filename = "developing_monthly.xlsx",
  source = "IMF",
  frequency = "monthly"
)

timestamp_save(
  df = split_dfs$other,
  filename = "others_monthly.xlsx",
  source = "IMF",
  frequency = "monthly"
)

# also save the combined file

timestamp_save(
  df = df_imf_monthly,
  filename = "all_monthly.xlsx",
  source = "IMF",
  frequency = "monthly"
)
```





